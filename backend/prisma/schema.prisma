// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========== CORE MODELS ==========

model User {
  id                String    @id @default(uuid())
  uid               String    @unique
  email             String    @unique
  password          String
  firstName         String?
  lastName          String?
  phone             String?
  avatar            String?
  role              UserRole  @default(CUSTOMER)
  emailVerified     Boolean   @default(false)
  isActive          Boolean   @default(true)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  orders            Order[]
  reviews           Review[]
  addresses         Address[]
  cart              CartItem[]
  wishlist          WishlistItem[]
  
  @@map("users")
}

enum UserRole {
  CUSTOMER
  ADMIN
  STAFF
}

model Address {
  id           String   @id @default(uuid())
  userId       String
  fullName     String
  street       String
  city         String
  state        String?
  country      String
  postalCode   String
  phone        String
  isDefault    Boolean  @default(false)
  createdAt    DateTime @default(now())
  
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  shippingOrders  Order[]  @relation("ShippingAddress")
  billingOrders   Order[]  @relation("BillingAddress")
  
  @@map("addresses")
}

// ========== PRODUCT SYSTEM ==========

model Category {
  id          String    @id @default(uuid())
  name        String
  slug        String    @unique
  description String?
  image       String?
  parentId    String?
  order       Int       @default(0)
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  parent      Category? @relation("CategoryToCategory", fields: [parentId], references: [id])
  children    Category[] @relation("CategoryToCategory")
  products    Product[]
  
  @@map("categories")
}

model Product {
  id              String        @id @default(uuid())
  name            String
  slug            String        @unique
  description     String
  shortDescription String?
  sku             String        @unique
  brand           String?
  
  // Pricing
  basePrice       Float
  salePrice       Float?
  costPrice       Float?
  
  // Inventory
  stockQuantity   Int           @default(0)
  lowStockThreshold Int         @default(5)
  isInStock       Boolean       @default(true)
  manageStock     Boolean       @default(true)
  
  // Product Type
  type            String        @default("SIMPLE")
  isVirtual       Boolean       @default(false)
  isDownloadable  Boolean       @default(false)
  
  // Visibility
  status          String        @default("DRAFT")
  isFeatured      Boolean       @default(false)
  isNew           Boolean       @default(false)
  isBestSeller    Boolean       @default(false)
  
  // SEO
  metaTitle       String?
  metaDescription String?
  metaKeywords    String?
  
  // Ratings
  averageRating   Float         @default(0)
  reviewCount     Int           @default(0)
  
  // Media
  images          Json          // Array of image URLs
  
  // Relations
  categoryId      String?
  category        Category?     @relation(fields: [categoryId], references: [id])
  
  // Variants & Tags
  variants        ProductVariant[]
  attributes      ProductAttribute[]
  tags            ProductTag[]
  reviews         Review[]
  orderItems      OrderItem[]
  cartItems       CartItem[]
  wishlistItems   WishlistItem[]
  
  // Timestamps
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  publishedAt     DateTime?
  
  @@index([status, isFeatured, isNew, isBestSeller])
  @@index([averageRating])
  @@index([createdAt])
  @@index([updatedAt])
  @@map("products")
}

enum ProductType {
  SIMPLE
  VARIABLE
  GROUPED
  BUNDLE
}

enum ProductStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
  OUT_OF_STOCK
}

model ProductVariant {
  id            String   @id @default(uuid())
  productId     String
  sku           String   @unique
  name          String   // e.g., "50ml", "Eau de Parfum"
  price         Float
  salePrice     Float?
  stockQuantity Int      @default(0)
  isInStock     Boolean  @default(true)
  attributes    Json     // e.g., {"size": "50ml", "concentration": "EDP"}
  image         String?
  order         Int      @default(0)
  
  product       Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  orderItems    OrderItem[]
  cartItems     CartItem[]
  
  @@map("product_variants")
}

model ProductAttribute {
  id          String   @id @default(uuid())
  productId   String
  name        String   // e.g., "Size", "Concentration", "Gender"
  value       String   // e.g., "50ml", "Eau de Parfum", "Unisex"
  
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  @@map("product_attributes")
}

// ========== TAG SYSTEM ==========

model ProductTag {
  id          String    @id @default(uuid())
  name        String
  slug        String    @unique
  type        TagType
  description String?
  icon        String?   // For UI display
  order       Int       @default(0)
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  
  products    Product[]
  
  @@map("product_tags")
}

enum TagType {
  SCENT_FAMILY
  PERFORMANCE
  AUDIENCE
  BENEFIT
  INGREDIENT
  PRODUCT_TYPE
  SEASON
  OCCASION
}

// ========== ORDER SYSTEM ==========

model Order {
  id                String        @id @default(uuid())
  orderNumber       String        @unique
  userId            String?
  customerEmail     String
  customerPhone     String?
  customerNote      String?
  
  // Status
  status            OrderStatus   @default(PENDING)
  paymentStatus     PaymentStatus @default(PENDING)
  fulfillmentStatus FulfillmentStatus @default(UNFULFILLED)
  
  // Totals
  subtotal          Float
  shippingTotal     Float         @default(0)
  taxTotal          Float         @default(0)
  discountTotal     Float         @default(0)
  total             Float
  
  // Shipping & Billing
  shippingAddressId String?
  billingAddressId  String?
  
  // Payment
  paymentMethod     String?
  transactionId     String?
  paystackReference String?       @unique
  
  // Relations
  user              User?         @relation(fields: [userId], references: [id])
  shippingAddress   Address?      @relation("ShippingAddress", fields: [shippingAddressId], references: [id])
  billingAddress    Address?      @relation("BillingAddress", fields: [billingAddressId], references: [id])
  items             OrderItem[]
  
  // Timestamps
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  paidAt            DateTime?
  shippedAt         DateTime?
  deliveredAt       DateTime?
  
  @@map("orders")
}

enum OrderStatus {
  PENDING
  PROCESSING
  ON_HOLD
  COMPLETED
  CANCELLED
  REFUNDED
  FAILED
}

enum PaymentStatus {
  PENDING
  AUTHORIZED
  PAID
  PARTIALLY_REFUNDED
  REFUNDED
  VOIDED
  FAILED
}

enum FulfillmentStatus {
  UNFULFILLED
  PARTIALLY_FULFILLED
  FULFILLED
}

model OrderItem {
  id               String         @id @default(uuid())
  orderId          String
  productId        String?
  variantId        String?
  productName      String
  variantName      String?
  sku              String
  quantity         Int
  price            Float
  subtotal         Float
  
  order            Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product          Product?       @relation(fields: [productId], references: [id])
  variant          ProductVariant? @relation(fields: [variantId], references: [id])
  
  @@map("order_items")
}

// ========== CART & WISHLIST ==========

model CartItem {
  id          String   @id @default(uuid())
  userId      String
  productId   String?
  variantId   String?
  quantity    Int      @default(1)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  product     Product? @relation(fields: [productId], references: [id])
  variant     ProductVariant? @relation(fields: [variantId], references: [id])
  
  @@unique([userId, productId, variantId])
  @@map("cart_items")
}

model WishlistItem {
  id          String   @id @default(uuid())
  userId      String
  productId   String
  createdAt   DateTime @default(now())
  
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  product     Product  @relation(fields: [productId], references: [id])
  
  @@unique([userId, productId])
  @@map("wishlist_items")
}

// ========== REVIEWS ==========

model Review {
  id          String    @id @default(uuid())
  productId   String
  userId      String
  rating      Int       @default(5) // 1-5
  title       String?
  comment     String?
  isApproved  Boolean   @default(false)
  isHelpful   Int       @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  product     Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("reviews")
}

// ========== CONTENT ==========

model Page {
  id          String    @id @default(uuid())
  title       String
  slug        String    @unique
  content     String?
  excerpt     String?
  featuredImage String?
  isPublished Boolean   @default(true)
  order       Int       @default(0)
  metaTitle   String?
  metaDescription String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  @@map("pages")
}

model Menu {
  id          String    @id @default(uuid())
  name        String
  slug        String    @unique
  items       Json      // Array of menu items
  location    String?   // e.g., "header", "footer", "sidebar"
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  @@map("menus")
}

// ========== SETTINGS ==========

model Setting {
  id          String    @id @default(uuid())
  key         String    @unique
  value       String?
  type        String    @default("string") // string, json, boolean, number
  group       String?   // e.g., "general", "shipping", "payment"
  isPublic    Boolean   @default(false)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  @@map("settings")
}